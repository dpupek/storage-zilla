name: Release MSIX Beta

on:
  push:
    branches:
      - beta

permissions:
  contents: write

jobs:
  release-beta:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install NBGV
        shell: pwsh
        run: dotnet tool install --global nbgv

      - name: Compute beta version
        id: version
        shell: pwsh
        run: |
          $json = nbgv get-version -f json
          $info = $json | ConvertFrom-Json
          $baseVersion = [string]$info.SimpleVersion
          if ([string]::IsNullOrWhiteSpace($baseVersion)) {
            throw "Could not resolve base version from NBGV."
          }
          $height = if ($info.VersionHeight -is [int]) { [int]$info.VersionHeight } else { [int]$env:GITHUB_RUN_NUMBER }
          if ($height -le 0) {
            $height = [int]$env:GITHUB_RUN_NUMBER
          }

          $prerelease = "beta.$height"
          $version = "$baseVersion-$prerelease"
          $tag = "v$version"
          "base_version=$baseVersion" >> $env:GITHUB_OUTPUT
          "prerelease=$prerelease" >> $env:GITHUB_OUTPUT
          "version=$version" >> $env:GITHUB_OUTPUT
          "tag=$tag" >> $env:GITHUB_OUTPUT
          "VERSION=$version" >> $env:GITHUB_ENV

      - name: Restore
        shell: pwsh
        run: dotnet restore AzureFilesSync.slnx

      - name: Build
        shell: pwsh
        run: |
          dotnet build AzureFilesSync.slnx `
            -c Release `
            /p:VersionPrefix=${{ steps.version.outputs.base_version }} `
            /p:VersionSuffix=${{ steps.version.outputs.prerelease }}

      - name: Test
        shell: pwsh
        run: |
          dotnet test AzureFilesSync.slnx `
            -c Release `
            --no-build `
            /p:VersionPrefix=${{ steps.version.outputs.base_version }} `
            /p:VersionSuffix=${{ steps.version.outputs.prerelease }}

      - name: Verify assembly informational version matches computed version
        shell: pwsh
        run: |
          $dll = Resolve-Path "src/AzureFilesSync.Desktop/bin/Release/net10.0-windows/AzureFilesSync.Desktop.dll"
          $actual = (Get-Item $dll).VersionInfo.ProductVersion
          $expected = "${{ steps.version.outputs.version }}"
          if ($actual -ne $expected) {
            throw "Assembly informational version mismatch. Expected '$expected' but found '$actual'."
          }

      - name: Prepare signing certificate
        shell: pwsh
        run: |
          $certPath = Join-Path $env:RUNNER_TEMP "storage-zilla-release.pfx"
          [IO.File]::WriteAllBytes($certPath, [Convert]::FromBase64String("${{ secrets.MSIX_CERT_BASE64 }}"))
          "MSIX_CERT_PATH=$certPath" >> $env:GITHUB_ENV

      - name: Apply package publisher from secret
        shell: pwsh
        run: |
          $manifestPath = "installer/StorageZilla.Package/Package.appxmanifest"
          [xml]$manifest = Get-Content $manifestPath
          $ns = New-Object System.Xml.XmlNamespaceManager($manifest.NameTable)
          $ns.AddNamespace("appx", "http://schemas.microsoft.com/appx/manifest/foundation/windows10")
          $identity = $manifest.SelectSingleNode("/appx:Package/appx:Identity", $ns)
          if ($null -eq $identity) {
            throw "Unable to find Package/Identity node in $manifestPath."
          }
          $publisherFromSecret = "${{ secrets.MSIX_PUBLISHER }}"
          if ([string]::IsNullOrWhiteSpace($publisherFromSecret)) {
            $existingPublisher = $identity.GetAttribute("Publisher")
            if ([string]::IsNullOrWhiteSpace($existingPublisher)) {
              throw "MSIX_PUBLISHER secret is empty and Package.appxmanifest has no Publisher."
            }
            Write-Host "MSIX_PUBLISHER secret not set; using manifest Publisher '$existingPublisher'."
          } else {
            $identity.SetAttribute("Publisher", $publisherFromSecret)
          }
          $manifest.Save($manifestPath)

      - name: Build signed MSIX package
        shell: pwsh
        run: |
          $packageDir = Join-Path $env:RUNNER_TEMP "msix"
          New-Item -ItemType Directory -Path $packageDir -Force | Out-Null

          msbuild installer/StorageZilla.Package/StorageZilla.Package.wapproj `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:AppxBundle=Never `
            /p:UapAppxPackageBuildMode=SideLoadOnly `
            /p:AppxPackageDir="$packageDir\\" `
            /p:AppxPackageSigningEnabled=true `
            /p:PackageCertificateKeyFile="$env:MSIX_CERT_PATH" `
            /p:PackageCertificatePassword="${{ secrets.MSIX_CERT_PASSWORD }}" `
            /p:AppxPackageVersion="${{ steps.version.outputs.base_version }}.0" `
            /p:RuntimeIdentifier=win-x64 `
            /p:SelfContained=true `
            /p:VersionPrefix=${{ steps.version.outputs.base_version }} `
            /p:VersionSuffix=${{ steps.version.outputs.prerelease }}

      - name: Resolve MSIX artifact
        id: artifact
        shell: pwsh
        run: |
          $msix = Get-ChildItem -Path (Join-Path $env:RUNNER_TEMP "msix") -Recurse -Filter *.msix | Select-Object -First 1
          if ($null -eq $msix) {
            throw "No .msix artifact was produced."
          }
          "msix_path=$($msix.FullName)" >> $env:GITHUB_OUTPUT

      - name: Write SHA256
        shell: pwsh
        run: |
          $hash = Get-FileHash "${{ steps.artifact.outputs.msix_path }}" -Algorithm SHA256
          $line = "$($hash.Hash.ToLowerInvariant()) *$([IO.Path]::GetFileName($hash.Path))"
          $shaPath = Join-Path (Split-Path "${{ steps.artifact.outputs.msix_path }}" -Parent) "SHA256SUMS.txt"
          Set-Content -Path $shaPath -Value $line -NoNewline

      - name: Publish GitHub prerelease
        uses: softprops/action-gh-release@v2
        with:
          prerelease: true
          tag_name: ${{ steps.version.outputs.tag }}
          target_commitish: ${{ github.sha }}
          name: Storage Zilla Beta v${{ steps.version.outputs.version }}
          generate_release_notes: true
          files: |
            ${{ steps.artifact.outputs.msix_path }}
            ${{ runner.temp }}\msix\SHA256SUMS.txt
